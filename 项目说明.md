# STK卫星星座数据采集项目详细说明

## 项目背景

本项目是基于STK软件的卫星星座数据采集系统，严格按照您提供的要求设计：

1. **使用STK软件结合Python代码进行生成**
2. **严格参考成功案例**: https://github.com/dinglinghu/icbm_warning
3. **统一配置参数文件**进行整个软件的参数配置
4. **严格使用统一时间管理器**，禁止使用系统时间
5. **为了加快仿真速度**，场景创建后对随机添加的导弹目标可不进行STK可视化展示

## 核心设计理念

### 1. 模块化架构
- **配置管理器**: 统一管理所有参数
- **时间管理器**: 严格控制仿真时间
- **STK管理器**: 处理STK COM接口
- **星座管理器**: Walker星座创建与配置
- **导弹管理器**: 导弹目标管理
- **可见性计算器**: 卫星-导弹可见性分析
- **数据采集器**: 数据采集与保存

### 2. 严格的时间管理
```python
# 禁止使用系统时间
# ❌ 错误做法
current_time = datetime.now()

# ✅ 正确做法
current_time = self.time_manager.current_simulation_time
```

### 3. 统一配置管理
所有参数都通过`config/config.yaml`文件配置，包括：
- Walker星座参数
- 载荷传感器配置
- 导弹轨迹参数
- 仿真时间设置
- 数据采集配置

## 数据采集流程详解

### 1. 建立仿真场景
```python
# 连接STK
stk_manager.connect()

# 检测现有项目
if stk_manager.should_skip_creation():
    logger.info("检测到现有项目，跳过创建")
else:
    # 创建新场景
    constellation_manager.create_walker_constellation()
```

### 2. 仿真时刻位移确定
```python
# 获取下一次采集时间（随机间隔）
next_time = time_manager.get_next_collection_time()

# 推进仿真时间
time_manager.advance_simulation_time(next_time)
```

### 3. 采集数据
```python
data_snapshot = {
    "collection_time": collection_time.isoformat(),
    "satellites": self._collect_satellite_data(),      # 所有卫星位置和姿态
    "missiles": self._collect_missile_data(),          # 导弹轨迹
    "visibility": self._collect_visibility_data()      # 可见性时间窗口
}
```

### 4. 判断是否保存数据
```python
if time_manager.should_save_data():  # 每10次采集保存一次
    saved_file = data_collector.save_collected_data()
```

### 5. 导弹目标随机添加
```python
# 随机间隔添加导弹
if random.random() < 0.3 and len(active_missiles) < max_concurrent:
    await self._add_random_missile()
```

## Walker星座配置详解

### 星座参数
```yaml
constellation:
  type: "Walker"
  planes: 3                    # 轨道面数量
  satellites_per_plane: 3      # 每个轨道面的卫星数量
  total_satellites: 9          # 总卫星数量
```

### 参考卫星轨道参数
```yaml
reference_satellite:
  altitude: 1800             # 轨道高度(km)
  inclination: 51.856        # 轨道倾角(度)
  eccentricity: 0.0          # 轨道偏心率
  arg_of_perigee: 12         # 近地点幅角(度)
  raan_offset: 24            # 升交点赤经偏移(度)
  mean_anomaly_offset: 180   # 平近点角偏移(度)
```

### 轨道参数计算
```python
def _calculate_satellite_orbital_params(self, ...):
    # 计算半长轴
    semi_major_axis = earth_radius + base_altitude
    
    # 计算RAAN (升交点赤经)
    raan = (plane_idx * raan_spacing + raan_offset) % 360.0
    
    # 计算平近点角
    mean_anomaly = (sat_idx * mean_anomaly_spacing + mean_anomaly_offset) % 360.0
```

## 载荷配置详解

### 光学传感器配置
```yaml
payload:
  type: "Optical_Sensor"
  mounting: "Nadir"            # 载荷安装方向：天底方向
  sensor_pattern: "Conic"      # 传感器模式：锥形
  inner_cone_half_angle: 66.1  # 内锥半角(度) - STK约束: 0.0° - 90.0°
  outer_cone_half_angle: 85.0  # 外锥半角(度) - STK约束: 0.0° - 180.0°
```

### 指向参数配置
```yaml
pointing:
  azimuth: 0.0              # 指向方位角(度)
  elevation: 90.0           # 指向俯仰角(度)
```

### 传感器约束
```yaml
constraints_range:
  min_range: 0              # 最小距离设为0，允许近距离跟踪
  max_range: 5000           # 最大距离增加到5000km，确保覆盖所有可能距离
  active: true              # 约束激活状态
```

## 导弹目标配置详解

### 全球随机位置
```yaml
missile:
  global_launch_positions:
    lat_range: [-60, 60]      # 纬度范围(度)
    lon_range: [-180, 180]    # 经度范围(度)
    alt_range: [0, 100]       # 高度范围(m)
  
  global_target_positions:
    lat_range: [-60, 60]      # 纬度范围(度)
    lon_range: [-180, 180]    # 经度范围(度)
    alt_range: [0, 100]       # 高度范围(m)
```

### 轨迹参数
```yaml
trajectory_params:
  max_altitude_range: [300, 1500]  # 最大高度范围(km)
  flight_time_range: [600, 1800]   # 飞行时间范围(秒)
```

## 数据采集信息详解

### 卫星数据
```json
{
  "satellite_id": "Satellite01",
  "position": {
    "time": "2025-07-26T04:05:30",
    "x": 1234567.8,
    "y": 2345678.9,
    "z": 3456789.0
  },
  "payload_status": {
    "type": "Optical_Sensor",
    "operational": true,
    "power_consumption": 80.0,
    "temperature": 25.0
  }
}
```

### 导弹数据
```json
{
  "missile_id": "ICBM_Threat_01",
  "trajectory": {
    "launch_position": {"lat": 45.0, "lon": 120.0, "alt": 0},
    "impact_position": {"lat": 35.0, "lon": 110.0, "alt": 0},
    "trajectory_points": [...],
    "flight_time": 1800
  },
  "flight_status": {
    "status": "in_flight",
    "flight_duration": 900
  }
}
```

### 可见性数据
```json
{
  "satellite_id": "Satellite01",
  "missile_id": "ICBM_Threat_01",
  "has_visibility": true,
  "access_intervals": [
    {
      "start": "26 Jul 2025 04:12:56.535",
      "stop": "26 Jul 2025 04:16:19.274"
    }
  ],
  "total_intervals": 1
}
```

## 运行说明

### 1. 环境准备
- 安装STK 12软件
- 安装Python 3.8+
- 安装依赖包: `pip install -r requirements.txt`

### 2. 配置修改
根据需要修改`config/config.yaml`中的参数

### 3. 运行系统
```bash
# 方式1: 直接运行
python main.py

# 方式2: 使用批处理脚本
run.bat
```

### 4. 输出文件
- 数据文件: `output/data/satellite_data_*.json`
- 日志文件: `stk_data_collection.log`

## 扩展功能

### 1. 可视化支持
可以扩展添加数据可视化功能，生成轨迹图表和统计报告

### 2. 实时监控
可以添加Web界面实时监控数据采集状态

### 3. 数据分析
可以添加数据分析模块，对采集的数据进行统计分析

### 4. 多场景支持
可以扩展支持多个仿真场景并行运行

## 技术特点

1. **严格的时间管理**: 完全基于仿真时间，不依赖系统时间
2. **模块化设计**: 各组件职责清晰，易于维护和扩展
3. **配置驱动**: 所有参数通过配置文件管理，灵活性强
4. **异常处理**: 完善的错误处理和日志记录
5. **数据质量**: 多层次的数据验证和质量控制

这个项目完全按照您的要求设计，严格参考了成功案例的架构，实现了完整的STK卫星星座数据采集功能。
